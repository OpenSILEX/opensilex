<template>
<div >
        <div class="spaced-actions">
          <opensilex-CreateButton
            v-if="
              user.hasCredential(
                credentials.CREDENTIAL_INFRASTRUCTURE_MODIFICATION_ID
              )
            "
            @click="createOrganization()"
            label="InfrastructureTree.add"
            class="createButton firstButton"
          ></opensilex-CreateButton>
          <opensilex-CreateButton
            v-if="
              user.hasCredential(
                credentials.CREDENTIAL_INFRASTRUCTURE_MODIFICATION_ID
              )
            "
            @click="createSite()"
            label="InfrastructureTree.addSite"
            class="createButton"
          ></opensilex-CreateButton>
        </div>
  <b-card>
    <!-- Card header -->
    <template v-slot:header>
      <h3>
        {{ $t("InfrastructureTree.infrastructure-component") }}
        &nbsp;
        <font-awesome-icon
          icon="question-circle"
          class="infrastructureHelp"
          v-b-tooltip.hover.top="$t('InfrastructureTree.infrastructure-help')"
        />
      </h3>

    </template>

    <!-- Card body -->
    <!-- Infrastructure filter -->
    <opensilex-StringFilter
      :filter.sync="filter"
      @update="updateFilter()"
      placeholder="InfrastructureTree.filter-placeholder"
    ></opensilex-StringFilter>

    <opensilex-TreeView
        :nodes.sync="nodes"
        @select="displayNodesDetail"
        ref="treeView"
    >
      <template v-slot:node="{ node }">
        <span class="item-icon">
          <opensilex-Icon
              :icon="$opensilex.getRDFIcon(node.data.rdf_type)"
          />
        </span>&nbsp;
        <strong v-if="node.data.selectedOrganization">{{ node.title }}</strong>
        <span v-if="!node.data.selectedOrganization">{{ node.title }}</span>
        <span class="tree-multiple-icon">
          <opensilex-Icon
              v-if="hasMultipleParents(node)"
              icon="fa#project-diagram"
              v-b-tooltip.hover.top="getMultipleParentsTooltip(node)" />
        </span>
      </template>

      <template v-slot:buttons="{ node }">
        <opensilex-DetailButton
          @click="showOrganizationOrSiteDetail(node.data)"
          :label="node.data.isOrganization ? $t('InfrastructureTree.showDetail') : $t('InfrastructureTree.showDetailSite')"
          :small="true"
        ></opensilex-DetailButton>
        <opensilex-EditButton
          v-if="
            user.hasCredential(
              credentials.CREDENTIAL_INFRASTRUCTURE_MODIFICATION_ID
            )
          "
          @click="editOrganizationOrSite(node.data)"
          :label="node.data.isOrganization ? $t('InfrastructureTree.edit') : $t('InfrastructureTree.editSite')"
          :small="true"
        ></opensilex-EditButton>
        <opensilex-Dropdown
            v-if="
              user.hasCredential(
                credentials.CREDENTIAL_INFRASTRUCTURE_MODIFICATION_ID
              ) && node.data.isOrganization
            "
            @click="(option) => createOrganizationOrSite(option, node.data.uri)"
            :small="true"
            :options="createOptions"
            icon="fa#plus"
            variant="outline-success"
            right
        >
        </opensilex-Dropdown>
        <opensilex-DeleteButton
          v-if="
            user.hasCredential(credentials.CREDENTIAL_INFRASTRUCTURE_DELETE_ID)
          "
          @click="deleteOrganizationOrSite(node.data)"
          :label="node.data.isOrganization ? $t('InfrastructureTree.delete') : $t('InfrastructureTree.deleteSite')"
          :small="true"
        ></opensilex-DeleteButton>
      </template>
    </opensilex-TreeView>

    <opensilex-ModalForm
      v-if="
        user.hasCredential(
          credentials.CREDENTIAL_INFRASTRUCTURE_MODIFICATION_ID
        )
      "
      ref="infrastructureForm"
      component="opensilex-InfrastructureForm"
      createTitle="InfrastructureTree.add"
      editTitle="InfrastructureTree.update"
      icon="ik#ik-globe"
      @onCreate="onCreate"
      @onUpdate="onUpdate"
      :initForm="initOrganizationForm"
    ></opensilex-ModalForm>
    <opensilex-ModalForm
        v-if="
          user.hasCredential(
            credentials.CREDENTIAL_INFRASTRUCTURE_MODIFICATION_ID
          )
        "
        ref="siteForm"
        component="opensilex-SiteForm"
        createTitle="InfrastructureTree.addSite"
        editTitle="InfrastructureTree.editSite"
        icon="ik#ik-globe"
        @onCreate="onCreate"
        @onUpdate="onUpdate"
        :initForm="initSiteForm"
        :doNotHideOnError="true"
    ></opensilex-ModalForm>
  </b-card>
</div>
</template>

<script lang="ts">
import {Component, Ref} from "vue-property-decorator";
import Vue from "vue";
import HttpResponse, {OpenSilexResponse} from "../../lib/HttpResponse";
import {InfrastructureGetDTO, InfrastructureUpdateDTO, ResourceDagDTO, SiteGetDTO, SiteUpdateDTO} from "opensilex-core/index";
import OpenSilexVuePlugin, {GenericTreeOption, TreeOption} from "../../models/OpenSilexVuePlugin";
import ModalForm from "../common/forms/ModalForm.vue";
import {DropdownButtonOption} from "../common/dropdown/Dropdown.vue";
import {OrganizationsService} from "opensilex-core/api/organizations.service";
import TreeView from "../common/views/TreeView.vue";
import DTOConverter from "../../models/DTOConverter";

type OrganizationOrSiteData = ResourceDagDTO & {
  isOrganization: boolean,
  isSite: boolean
}

interface OrganizationOrSiteTreeNode extends TreeOption<OrganizationOrSiteTreeNode> {
  data: OrganizationOrSiteData
}

enum AddOption {
  ADD_ORGANIZATION = "Add organization",
  ADD_SITE= "Add site"
}

@Component
export default class InfrastructureTree extends Vue {
  $opensilex: OpenSilexVuePlugin;
  $store: any;
  $route: any;
  service: OrganizationsService;

  nodes: Array<OrganizationOrSiteTreeNode> = [];

  parentURI: string;

  private langUnwatcher;

  private selectedOrganization: InfrastructureGetDTO;
  private selectedSite: SiteGetDTO;

  @Ref("infrastructureForm") readonly infrastructureForm!: ModalForm;
  @Ref("siteForm") readonly siteForm!: ModalForm;
  @Ref("treeView") readonly treeView: TreeView<OrganizationOrSiteData>;

  private createOptions: Array<DropdownButtonOption> = [
    {
      label: this.$t("InfrastructureTree.add-child").toString(),
      id: AddOption.ADD_ORGANIZATION,
      data: AddOption.ADD_ORGANIZATION
    },
    {
      label: this.$t("InfrastructureTree.addSite").toString(),
      id: AddOption.ADD_SITE,
      data: AddOption.ADD_SITE
    }
  ];

  get user() {
    return this.$store.state.user;
  }

  get credentials() {
    return this.$store.state.credentials;
  }

  private hasMultipleParents(node: OrganizationOrSiteTreeNode) {
    return node.data.parents.length > 1;
  }

  private getMultipleParentsTooltip(node: OrganizationOrSiteTreeNode) {
    if (node.data.isOrganization) {
      return this.$t("InfrastructureTree.organization-multiple-tooltip");
    }
    return this.$t("InfrastructureTree.site-multiple-tooltip");
  }

  private filter: any = "";

  updateFilter() {
    this.$opensilex.updateURLParameter("filter", this.filter, "");
    this.refresh();
  }

  created() {
    this.service = this.$opensilex.getService(
      "opensilex-core.OrganizationsService"
    );

    let query: any = this.$route.query;
    if (query.filter) {
      this.filter = decodeURIComponent(query.filter);
    }

    this.refresh();
  }

  mounted() {
    this.langUnwatcher = this.$store.watch(
      () => this.$store.getters.language,
      (lang) => {
        if (this.selectedOrganization != null) {
          this.displayOrganizationDetail(this.selectedOrganization.uri, true);
        }
      }
    );
  }

  beforeDestroy() {
    this.langUnwatcher();
  }

  refresh(uri?): Promise<void> {
    return Promise.all([
      this.fetchOrganizationsAsTree(),
      this.fetchSites()
    ]).then(result => {
      let tree: Array<GenericTreeOption> = result[0];
      let sites: Array<SiteGetDTO> = result[1];

      // Keep no selection
      this.selectedOrganization = undefined;
      this.selectedSite = undefined;

      this.nodes = this.appendSitesToTree(tree, sites);

      if (uri) {
        this.selectFirstNode(node => node.data.uri === uri);
      } else {
        this.$emit("onSelect");
      }
    }).catch(this.$opensilex.errorHandler);
  }

  /**
   * Programmatically select the first node that matches the given predicate.
   *
   * @param predicate
   * @param currentNode The node to explore with its children. If not specified, all nodes will be explored.
   */
  selectFirstNode(predicate: (node: OrganizationOrSiteTreeNode) => boolean, currentNode?: OrganizationOrSiteTreeNode): OrganizationOrSiteTreeNode {
    // If no current node is given, apply the method on each root node
    if (!currentNode) {
      for (let node of this.nodes) {
        let result = this.selectFirstNode(predicate, node);
        if (result) {
          return result;
        }
      }
      return undefined;
    }

    // Test the predicate against the current node
    if (predicate(currentNode)) {
      // Select it
      currentNode.isSelected = true;
      this.displayNodesDetail(currentNode);
      return currentNode;
    }

    // Test the predicate against the children
    if (currentNode.children) {
      for (let node of currentNode.children) {
        let result = this.selectFirstNode(predicate, node);
        if (result) {
          return result;
        }
      }
    }
    return undefined;
  }

  private async fetchOrganizationsAsTree(): Promise<Array<GenericTreeOption>> {
    try {
      let orgHttp: HttpResponse<OpenSilexResponse<Array<ResourceDagDTO>>> = await this.service.searchInfrastructures(this.filter);

      if (this.infrastructureForm && this.infrastructureForm.getFormRef()) {
        if (this.filter == "") {
          this.infrastructureForm
              .getFormRef()
              .setParentInfrastructures(orgHttp.response.result);
        } else {
          this.infrastructureForm.getFormRef().init();
        }
      }

      return this.$opensilex.buildTreeFromDag(orgHttp.response.result, {});
    } catch (e) {
      this.$opensilex.errorHandler(e);
      throw e;
    }
  }

  private async fetchSites(): Promise<Array<SiteGetDTO>> {
    return (await this.service.searchSites(this.filter)).response.result;
  }

  private appendSitesToTree(tree: Array<GenericTreeOption>, sites: Array<SiteGetDTO>): Array<OrganizationOrSiteTreeNode> {
    return this.$opensilex.mapTree<GenericTreeOption, OrganizationOrSiteTreeNode>(tree, (node, mappedChildren) => {
      let orgNode: OrganizationOrSiteTreeNode = {
        ...node,
        children: mappedChildren,
        data: {
          ...node.data,
          isOrganization: true,
          isSite: false
        }
      };

      for (let site of sites) {
        for (let org of site.organizations) {
          if (org.uri === orgNode.id) {
            if (!Array.isArray(orgNode.children)) {
              orgNode.children = [];
            }
            let siteNodeData: OrganizationOrSiteData = {
              isSite: true,
              isOrganization: false,
              uri: site.uri,
              name: site.name,
              rdf_type: site.rdf_type,
              rdf_type_name: site.rdf_type_name,
              children: [],
              parents: site.organizations.map(org => org.uri)
            };
            let siteNode: OrganizationOrSiteTreeNode = {
              id: site.uri,
              children: [],
              isDefaultExpanded: true,
              isExpanded: true,
              isDisabled: false,
              isLeaf: true,
              label: site.name,
              data: siteNodeData,
              title: site.name,
              isSelectable: true
            };
            orgNode.isLeaf = false;
            orgNode.children.push(siteNode);
          }
        }
      }

      return orgNode;
    });
  }

  public displayNodesDetail(node: OrganizationOrSiteTreeNode) {
    if (node.data.isOrganization) {
      this.displayOrganizationDetail(node.data.uri);
    } else if (node.data.isSite) {
      this.displaySiteDetail(node.data.uri);
    }
  }

  public displayOrganizationDetail(uri: string, forceRefresh?: boolean) {
    if (forceRefresh || this.selectedOrganization == null || this.selectedOrganization.uri != uri) {
      return this.service
        .getInfrastructure(uri)
        .then((http: HttpResponse<OpenSilexResponse<InfrastructureGetDTO>>) => {
          let detailDTO: InfrastructureGetDTO = http.response.result;
          this.selectedOrganization = detailDTO;
          this.selectedSite = undefined;
          this.$emit("onSelect", detailDTO);
        });
    }
  }

  public displaySiteDetail(uri: string, forceRefresh?: boolean) {
    if (forceRefresh || this.selectedOrganization == null || this.selectedOrganization.uri != uri) {
      return this.service
        .getSite(uri)
        .then((http: HttpResponse<OpenSilexResponse<SiteGetDTO>>) => {
          let siteDto = http.response.result;
          this.selectedSite = siteDto;
          this.selectedOrganization = undefined;
          this.$emit("onSelect", siteDto);
        });
    }
  }

  showOrganizationOrSiteDetail(siteOrOrg: OrganizationOrSiteData) {
    if (siteOrOrg.isOrganization) {
      this.showOrganizationDetail(siteOrOrg.uri);
    } else if (siteOrOrg.isSite) {
      this.showSiteDetail(siteOrOrg.uri);
    }
  }

  editOrganizationOrSite(siteOrOrg: OrganizationOrSiteData) {
    if (siteOrOrg.isOrganization) {
      this.editOrganization(siteOrOrg.uri);
    } else if (siteOrOrg.isSite) {
      this.editSite(siteOrOrg.uri);
    }
  }

  deleteOrganizationOrSite(siteOrOrg: OrganizationOrSiteData) {
    if (siteOrOrg.isOrganization) {
      this.deleteOrganization(siteOrOrg.uri);
    } else if (siteOrOrg.isSite) {
      this.deleteSite(siteOrOrg.uri);
    }
  }

  showOrganizationDetail(uri) {
    this.$router.push({
      path: "/infrastructure/details/" + encodeURIComponent(uri),
    });
  }

  createOrganizationOrSite(option: DropdownButtonOption, uri?: string) {
    if (option.data === AddOption.ADD_ORGANIZATION) {
      this.createOrganization(uri);
    } else if (option.data === AddOption.ADD_SITE) {
      this.createSite(uri);
    }
  }

  createOrganization(parentURI?) {
    this.parentURI = parentURI;
    this.infrastructureForm.showCreateForm();
  }

  editOrganization(uri) {
    this.service
      .getInfrastructure(uri)
      .then((http: HttpResponse<OpenSilexResponse<InfrastructureGetDTO>>) => {
        let detailDTO: InfrastructureGetDTO = http.response.result;
        this.parentURI = Array.isArray(detailDTO.parents) && detailDTO.parents.length > 0
          ? detailDTO.parents[0].uri
          : undefined;

        let editDTO: InfrastructureUpdateDTO = DTOConverter.extractURIFromResourceProperties(detailDTO);
        this.infrastructureForm.showEditForm(editDTO);
      });
  }

  deleteOrganization(uri: string) {
    this.service
      .deleteInfrastructure(uri)
      .then(() => {
        this.$emit("onDelete");
        this.refresh();
      })
      .catch(this.$opensilex.errorHandler);
  }

  showSiteDetail(uri) {
    this.$router.push({
      path: "/infrastructure/site/details/" + encodeURIComponent(uri),
    });
  }

  createSite(parentURI?: string) {
    this.parentURI = parentURI;
    this.siteForm.showCreateForm();
  }

  editSite(uri) {
    this.service
        .getSite(uri)
        .then((http: HttpResponse<OpenSilexResponse<SiteGetDTO>>) => {
          let editDTO: SiteUpdateDTO = DTOConverter.extractURIFromResourceProperties(http.response.result);
          this.siteForm.showEditForm(editDTO);
        });
  }

  deleteSite(uri) {
    this.service
        .deleteSite(uri)
        .then(() => {
          this.$emit("onDelete");
          this.refresh();
        })
        .catch(this.$opensilex.errorHandler);
  }

  initOrganizationForm(form) {
    form.parents = [this.parentURI];
  }

  initSiteForm(form) {
    if (this.parentURI) {
      form.organizations = [this.parentURI];
    }
  }

  onCreate() {
    let selectedNode = this.treeView.getSelectedNode();
    this.refresh(selectedNode?.uri);
    this.$emit("onCreate");
  }

  onUpdate() {
    let selectedNode = this.treeView.getSelectedNode();
    this.refresh(selectedNode?.uri);
    this.$emit("onCreate");
  }
}
</script>

<style scoped lang="scss">
.sl-vue-tree-root {
  min-height: 100px;
  max-height: 300px;
  overflow-y: auto;
}

::v-deep .sl-vue-tree-nodes-list {
  overflow: visible;
}

.leaf-spacer {
  display: inline-block;
  width: 23px;
}
.infrastructureHelp{
  font-size: 1.3em;
  background: #f1f1f1;
  color: #00A38D;
  border-radius: 50%;
}


@media (max-width: 768px) {
  .sl-vue-tree-root {
    min-height: auto;
  }
}

.tree-multiple-icon {
  padding-left: 8px;
  color: #3cc6ff;
}

.spaced-actions {
  margin-top: -15px;
  margin-bottom: 10px;
}

.firstButton {
  margin-right: 10px;
}

</style>

<i18n>
en:
  InfrastructureTree:
    filter-placeholder: Search organizations...
    add: Add organization
    update: Update organization
    edit: Edit organization
    add-child: Add sub-organization
    addSite: Add site
    editSite: Edit site
    delete: Delete organization
    deleteSite: Delete site
    infrastructure-component: Organizations and sites
    infrastructure-help: "The organizations represent the hierarchy between the different sites, units, ... with a specific address and / or with dedicated teams."
    showDetail: Organization details
    showDetailSite: Site details
    organization-multiple-tooltip: "This organization has several parent organizations"
    site-multiple-tooltip: "This site hosts several organizations"
fr:
  InfrastructureTree:
    filter-placeholder: Rechercher des organisations...
    add: Ajouter une organisation
    update: Modifier l'organisation
    edit: Editer l'organisation
    add-child: Ajouter une sous-organisation
    addSite: Ajouter un site
    editSite: Editer le site
    delete: Supprimer l'organisation
    deleteSite: Supprimer le site
    infrastructure-component: Organisations et sites
    infrastructure-help: "Les organisations représentent la hiérarchie entre les différents sites, unités, ... disposant d'une adresse particulière et/ou avec des équipes dédiées."
    showDetail: Détail de l'organisation
    showDetailSite: Détail du site
    organization-multiple-tooltip: "Cette organisation a plusieurs organisations parentes"
    site-multiple-tooltip: "Ce site héberge plusieurs organisations"


</i18n>
